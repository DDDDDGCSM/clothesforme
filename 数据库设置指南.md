# Neon 数据库设置指南

本指南将帮助你为 Trueque Digital 项目设置免费的 Neon PostgreSQL 数据库，实现数据持久化存储。

## 方式一：通过 Vercel Dashboard 集成（推荐，最简单）

### 步骤 1：登录 Vercel Dashboard
1. 访问 https://vercel.com/dashboard
2. 登录你的账号
3. 找到 `bookforMX` 项目并点击进入

### 步骤 2：添加 Vercel Postgres
1. 在项目页面，点击顶部的 **"Storage"** 或 **"Integrations"** 标签
2. 点击 **"Create Database"** 或 **"Add Integration"**
3. 选择 **"Vercel Postgres"**（基于 Neon）
4. 选择 **"Free"** 计划
5. 点击 **"Create"**

### 步骤 3：自动配置
- Vercel 会自动创建数据库实例
- 自动在环境变量中添加 `POSTGRES_URL`
- 自动连接到你的项目

### 步骤 4：验证设置
1. 在项目设置中，查看 **"Environment Variables"**
2. 确认 `POSTGRES_URL` 已存在
3. 重新部署项目（或等待自动部署）

---

## 方式二：通过 Neon 官网注册（更灵活）

### 步骤 1：注册 Neon 账号
1. 访问 https://console.neon.tech/signup
2. 使用 GitHub、Google 或邮箱注册
3. 完成邮箱验证（如需要）

### 步骤 2：创建数据库项目
1. 登录后，点击 **"Create a project"**
2. 填写项目信息：
   - **Project name**: `bookforMX` 或 `trueque-digital`
   - **Region**: 选择离你最近的区域（如 `us-east-2`）
   - **PostgreSQL version**: 选择最新版本（默认即可）
3. 点击 **"Create project"**

### 步骤 3：获取连接字符串
1. 项目创建后，在 Dashboard 中会显示连接信息
2. 找到 **"Connection string"** 或 **"Connection details"**
3. 复制连接字符串，格式类似：
   ```
   postgres://username:password@ep-xxx.us-east-2.aws.neon.tech/neondb?sslmode=require
   ```

### 步骤 4：在 Vercel 中配置环境变量
1. 访问 https://vercel.com/dashboard
2. 进入 `bookforMX` 项目
3. 点击 **"Settings"** → **"Environment Variables"**
4. 添加以下环境变量：
   - **Name**: `DATABASE_URL` 或 `NEON_DATABASE_URL`
   - **Value**: 粘贴从 Neon 复制的连接字符串
   - **Environment**: 选择 `Production`, `Preview`, `Development`（全选）
5. 点击 **"Save"**

### 步骤 5：重新部署
1. 在 Vercel Dashboard 中，进入 **"Deployments"**
2. 点击最新部署右侧的 **"..."** 菜单
3. 选择 **"Redeploy"**
4. 等待部署完成

---

## 验证数据库连接

部署完成后，系统会自动：
1. ✅ 检测 `DATABASE_URL` 或 `POSTGRES_URL` 环境变量
2. ✅ 连接到 Neon 数据库
3. ✅ 自动创建 `book_exchange_events` 表
4. ✅ 创建必要的索引

### 检查日志
1. 在 Vercel Dashboard 中，进入 **"Deployments"**
2. 点击最新部署，查看 **"Build Logs"**
3. 查找以下信息：
   - ✅ `数据库连接成功，使用持久化存储` - 表示连接成功
   - ⚠️ `数据库连接失败，使用内存存储` - 表示连接失败，需要检查环境变量

### 测试数据持久化
1. 访问你的网站：https://bookfor-mx.vercel.app/
2. 浏览几本书、点击 WhatsApp、提交一次交换申请
3. 刷新页面
4. 访问后台统计：https://bookfor-mx.vercel.app/admin/stats?token=20260109ForMXG
5. 检查数据是否还在（如果使用内存存储，刷新后数据会丢失）

---

## 免费层限制

Neon 免费层包括：
- ✅ **0.5 GiB** 存储空间（足够存储大量埋点数据）
- ✅ **10 个项目**
- ✅ **每月 190 小时** 计算时间
- ✅ 自动休眠（空闲时自动暂停，节省资源）

对于你的书籍交换平台，免费层完全够用！

---

## 故障排查

### 问题 1：数据库连接失败
**可能原因**：
- 环境变量未正确设置
- 连接字符串格式错误
- 数据库实例已暂停（Neon 免费层会自动休眠）

**解决方法**：
1. 检查 Vercel 环境变量是否正确
2. 访问 Neon Dashboard，确认数据库状态
3. 如果数据库已暂停，点击 **"Resume"** 恢复

### 问题 2：表未创建
**可能原因**：
- 数据库连接失败
- 权限问题

**解决方法**：
1. 检查部署日志中的错误信息
2. 确认连接字符串包含正确的数据库名称
3. 在 Neon Dashboard 的 SQL Editor 中手动创建表（如果需要）

### 问题 3：数据仍然丢失
**可能原因**：
- 环境变量未在正确的环境中设置
- 部署时环境变量未生效

**解决方法**：
1. 确认环境变量在所有环境（Production、Preview、Development）中都设置了
2. 重新部署项目
3. 检查部署日志确认数据库连接成功

---

## 下一步

设置完成后，你的数据将：
- ✅ **持久化存储**：刷新后不会丢失
- ✅ **自动备份**：Neon 提供自动备份
- ✅ **可扩展**：未来可以轻松升级到付费计划

如果遇到任何问题，请查看：
- Neon 文档：https://neon.tech/docs
- Vercel Postgres 文档：https://vercel.com/docs/storage/vercel-postgres

