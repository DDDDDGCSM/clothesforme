# 数据库设置指南 - 解决数据丢失问题

## 问题原因

当前系统使用**内存存储**，数据存储在服务器内存中。当 Vercel 服务器重启或重新部署时，内存中的数据会丢失，导致：
- 刷新页面后数据消失
- 重新部署后所有统计数据清零

## 解决方案：配置数据库持久化存储

代码已经支持 PostgreSQL 数据库，只需要配置环境变量即可。

### 推荐方案：使用 Neon（免费）

Neon 是免费的 PostgreSQL 数据库服务，非常适合 Vercel 部署。

#### 快速设置步骤

1. **创建 Neon 数据库**
   - 访问 https://neon.tech
   - 使用 GitHub 登录（最简单）
   - 点击 "Create a project"
   - 选择免费计划
   - 复制连接字符串（Connection String）

2. **在 Vercel 中配置环境变量**
   - 访问 https://vercel.com/dashboard
   - 进入 `changeeverything` 项目
   - 点击 **Settings** → **Environment Variables**
   - 添加环境变量：
     - **Name**: `DATABASE_URL`
     - **Value**: 从 Neon 复制的连接字符串
     - **Environment**: 全选（Production, Preview, Development）
   - 点击 **Save**

3. **重新部署**
   - 在 Vercel Dashboard 中
   - 进入 **Deployments**
   - 点击最新部署右侧的 **"..."** → **Redeploy**

#### 验证是否成功

部署后，查看 Vercel 的部署日志，应该看到：
- ✅ `数据库连接成功，使用持久化存储` - 成功！
- ⚠️ `数据库连接失败，使用内存存储` - 失败，检查环境变量

### 其他数据库选项

代码支持以下环境变量（按优先级）：
- `DATABASE_URL`
- `POSTGRES_URL`
- `NEON_DATABASE_URL`
- `SUPABASE_DATABASE_URL`

你也可以使用：
- **Supabase**（免费）：https://supabase.com
- **Vercel Postgres**（通过 Vercel Dashboard 直接添加）

## 注意事项

1. **免费额度**：Neon 免费层提供 0.5GB 存储，足够使用
2. **自动休眠**：Neon 在无活动时会休眠，首次访问可能需要几秒唤醒（正常现象）
3. **数据迁移**：配置数据库后，之前的内存数据不会自动迁移，需要重新产生数据

## 依赖检查

`requirements.txt` 已包含 `psycopg2-binary==2.9.9`，无需额外安装。

---

配置完成后，数据将永久保存，不会因为刷新或重新部署而丢失！
